// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // 添加连接池配置以解决连接重置问题
  // connection_limit: 最大连接数
  // pool_timeout: 获取连接的超时时间（秒）
  // connect_timeout: 建立连接的超时时间（秒）
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  passwordHash  String?    // for email/password authentication
  googleId      String?    @unique // for Google OAuth
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  events        Event[]    @relation("UserEvents")

  @@index([email])
  @@index([googleId])
}

model Event {
  id                 String     @id
  title              String
  description        String?
  timezone           String     // IANA timezone (e.g., "Asia/Shanghai")
  startDate          DateTime   // UTC
  endDate            DateTime   // UTC
  mode               String     @default("timeRange") // "timeRange" or "fullDay"
  timeMode           String     @default("standard")  // "standard", "period", or "custom"
  dayStartTime       String?    // HH:mm format (e.g., "09:00"), for standard mode
  dayEndTime         String?    // HH:mm format (e.g., "22:00"), for standard mode
  slotMinutes        Int?       // 15, 30, or 60, for standard mode
  minDurationMinutes Int?       // minimum meeting duration, for standard mode
  customTimeSlots    Json?      // for custom mode: [{label: "下午 4-5", startTime: "16:00", endTime: "17:00"}]
  adminToken         String     @unique
  userId             String?    // Creator of the event
  user               User?      @relation("UserEvents", fields: [userId], references: [id], onDelete: SetNull)
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt
  responses          Response[]

  @@index([adminToken])
  @@index([userId])
}

model Response {
  id                String   @id @default(cuid())
  eventId           String
  event             Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name              String?  // participant name (optional)
  email             String   // participant email (required for uniqueness)
  availabilitySlots Int[]    // array of slot indices
  sessionToken      String   @unique // for allowing edits from same device
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([eventId, email]) // Ensure one response per email per event
  @@index([eventId])
  @@index([sessionToken])
}
